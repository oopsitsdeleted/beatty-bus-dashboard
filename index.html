<!-- Made with love by Lokweng 2026 -->
<!-- Contains information from the Bus Arrival (v3) and Bus Routes datasets which is made available under the terms of the Singapore Open Data Licence version 1.0 https://data.gov.sg/open-data-licence -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beatty Bus Dashboard</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.svg">
    <style>
        :root {
            --background: #000000;
            --foreground: #ffffff;
            --card-background: #1e1e1e;
            --bus-number-bg: #000C53;
            --bus-number-text: #FFE200;
            --status-available: #1ef92d;
            --status-warning: #f5cf37;
            --status-limited: #f52121;
            --divider: #ffffff;
            --border-radius-card: 4px;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            margin: 0;
            padding: 5px 15px;
            overflow-x: hidden;
        }

        .container { max-width: 100%; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; padding: 0; }
        .title { font-size: 24px; font-weight: 900; line-height: 1; }
        .logo { height: 80px; width: auto; background: transparent; }
        .legend-items { display: flex; gap: 10px; font-size: 11px; margin-top: 2px; opacity: 0.9; }
        .legend-seats { color: var(--status-available); font-weight: bold; }
        .legend-standing { color: var(--status-warning); font-weight: bold; }
        .legend-limited { color: var(--status-limited); font-weight: bold; }
        .bus-block-section { margin-bottom: 12px; }
        .title-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 3px; }
        .section-title { font-size: 14px; font-weight: 700; color: #ccc; text-transform: uppercase; }
        .stop-crowd-indicator { font-size: 12px; font-weight: 800; }
        .divider { height: 1px; background: var(--divider); margin-bottom: 6px; opacity: 0.3; }
        .bus-timing-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 6px; }
        .bus-timing-card { background: var(--card-background); border-radius: var(--border-radius-card); display: flex; align-items: center; height: 42px; overflow: hidden; border: 1px solid #333; }
        .bus-number-badge { background: var(--bus-number-bg); width: 45px; height: 100%; display: flex; justify-content: center; align-items: center; font-size: 16px; font-weight: 900; color: var(--bus-number-text); flex-shrink: 0; }
        .bus-info { display: flex; flex: 1; justify-content: space-around; align-items: center; padding: 0 2px; }
        .time-val { font-size: 15px; font-weight: 800; }
        .v-sep { width: 1px; height: 18px; background: #444; }
        .green { color: var(--status-available); }
        .warning { color: var(--status-warning); }
        .limited { color: var(--status-limited); }
        .normal { color: #fff; }

        .last-update {
            position: fixed;
            bottom: 5px;
            right: 15px;
            font-size: 10px;
            color: #777;
            text-align: right;
            line-height: 1.4;
            text-transform: lowercase;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <div class="title">Bus Timings</div>
                <div class="legend-items">
                    <span class="legend-seats">● Seating available</span>
                    <span class="legend-standing">● Standing available</span>
                    <span class="legend-limited">● Standing limited</span>
                </div>
            </div>
            <img src="assets/beattycrest.png" alt="Logo" class="logo">
        </div>
        <div id="busStopsContainer"></div>
        <div id="lastUpdate" class="last-update"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        const BUS_STOP_NAMES = {
            '52369': 'Blk 237 (Back gate)',
            '52361': 'Blk 1 (Opposite back gate)',
            '52031': 'Opp Blk 998 (Main gate, opposite industrial & near GYSS)',
            '52039': 'Aft Muhajirin Mque (Main gate, after industrial)'
        };

        function isInOperation(schedule) {
            if (!schedule) return true; 
            const now = new Date();
            const time = now.getHours() * 100 + now.getMinutes();
            const day = now.getDay();
            let first, last;
            if (day === 0) { first = schedule.SUN_FirstBus; last = schedule.SUN_LastBus; }
            else if (day === 6) { first = schedule.SAT_FirstBus; last = schedule.SAT_LastBus; }
            else { first = schedule.WD_FirstBus; last = schedule.WD_LastBus; }
            
            first = parseInt(first); last = parseInt(last);
            return (last < first) ? (time >= first || time <= last) : (time >= first && time <= last);
        }

        function formatTime(bus, schedule) {
            if (bus?.EstimatedArrival) {
                const diff = Math.floor((new Date(bus.EstimatedArrival) - new Date()) / 60000);
                return diff < 1 ? 'Arr' : diff;
            }
            return isInOperation(schedule) ? '?' : '✘'; 
        }

        function getLvl(bus) {
            if (bus?.Load === 'SEA') return 'green';
            if (bus?.Load === 'SDA') return 'warning';
            if (bus?.Load === 'LSD') return 'limited';
            return 'normal'; 
        }

        function getStopCrowdStatus(services) {
            if (!services || services.length === 0) return { text: '', class: '' };
            const loads = services.map(s => s.NextBus.Load);
            if (loads.includes('LSD')) return { text: 'High crowd at this stop', class: 'limited' };
            if (loads.includes('SDA')) return { text: 'Moderate crowd at this stop', class: 'warning' };
            return { text: 'Low crowd at this stop', class: 'green' };
        }

        async function updateData() {
            try {
                const res = await fetch(`${API_BASE_URL}/bus-arrivals`);
                const json = await res.json();
                if (json.success) {
                    render(json.data);
                    document.getElementById('lastUpdate').innerHTML = `last updated: ${new Date().toLocaleTimeString()}<br>Non Vi Sed Arte | Contains information from the Bus Arrival (v3) and Bus Routes datasets | V1.9`;
                }
            } catch (e) { console.error(e); }
        }

        function render(data) {
            document.getElementById('busStopsContainer').innerHTML = data.map(stop => {
                const svcs = (stop.data.Services || []).sort((a,b) => parseInt(a.ServiceNo) - parseInt(b.ServiceNo));
                const crowd = getStopCrowdStatus(svcs);

                return `
                    <div class="bus-block-section">
                        <div class="title-row">
                            <div class="section-title">${BUS_STOP_NAMES[stop.busStopCode] || stop.busStopCode}</div>
                            <div class="stop-crowd-indicator ${crowd.class}">${crowd.text}</div>
                        </div>
                        <div class="divider"></div>
                        <div class="bus-timing-row">
                            ${svcs.map(s => `
                                <div class="bus-timing-card">
                                    <div class="bus-number-badge">${s.ServiceNo}</div>
                                    <div class="bus-info">
                                        <div class="time-val ${getLvl(s.NextBus)}">${formatTime(s.NextBus, s.schedule)}</div>
                                        <div class="v-sep"></div>
                                        <div class="time-val ${getLvl(s.NextBus2)}">${formatTime(s.NextBus2, s.schedule)}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        updateData();
        setInterval(updateData, 20000);
    </script>
</body>
</html>